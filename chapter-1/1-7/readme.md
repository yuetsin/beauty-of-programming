# 1.7 光影切割问题

## ★★★

不少人很爱玩游戏，例如「CS」（Counter-Strike，或者 Half-life）。游戏设计也成为了程序开发的热点之一。

我们假设要设计破旧仓库之类的场景作为战争游戏的背景。仓库的地面会因为阳光从屋顶的漏洞或者窗口照射进来而形成许多光照区域和阴影区域。为了简单起见，假设不同的区域的边界都是直线，我们把这些直线都叫做「光影线」，并且不存在三条光影线相交于一点的情况。如下图所示：

![image-20200227114943119](readme.assets/image-20200227114943119.png)

那么，如果我们需要快速计算某个时刻，在 $x$ 坐标 $[A, B]$ 区间内的地板上被光影划分成多少块。如何才能写出算法来计算呢？

## 解

 ### Mathematical

从几何学的角度分析一下这道题。

本质上，被光影切分出的「块」是如何产生的呢？感觉上，光影直线彼此交点越多，就会产生越多的分块。

那么，更具体的关系又是怎么表现的呢？

我们还是先从最简单的情况开始分析。

#### One Line

首先，一条直线不会产生交点，只可能将平面分为两部分。

![image-20200227122056025](readme.assets/image-20200227122056025.png)

#### Two Lines

而两条直线呢？存在下面两种情况：

![image-20200227121817854](readme.assets/image-20200227121817854.png)

![image-20200227121652753](readme.assets/image-20200227121652753.png)

其中「 $0$ 个交点」对应「将平面分成 $3$ 部分」，而 「$1$ 个交点」对应「将平面分成 $4$ 部分」。

#### Three Lines

再看看三条光影线的情况：

![image-20200227122022686](readme.assets/image-20200227122022686.png)

「$0$ 个交点的情况」对应「平面分为 $4$ 部分」。

![image-20200227122239235](readme.assets/image-20200227122239235.png)

「$1$ 个交点的情况」对应「平面分为 $5$ 部分」。

![image-20200227122349095](readme.assets/image-20200227122349095.png)

「$2$ 个交点的情况」对应「平面分为 $6$ 部分」。

![image-20200227122500189](readme.assets/image-20200227122500189.png)

「$3$ 个交点的情况」对应「平面分为 $7$ 部分」。

#### Generalization

根据上面的推论，$n$ 条直线、产生 $k$ 个交点，总共将平面分为 $n + k + 1$ 个部分（注意题目已经排除了「多条直线交于一点」的特殊情况）。

那么问题就转化为「求交点个数」的问题了——这很容易，可以在 $O(n^2)$ 时间内完成。

#### Proof

为什么？我们采用数学归纳法的方法进行论证。

假设目前平面上已经有了 $k - 1$ 条直线。我们现在将第 $k$ 条投影到平面上，他与之前 $k - 1$ 条直线的交点个数记为 $N_k$。

注意，因为没有三条及以上的直线会交于一点，因此这 $N_k$ 个交点都不会跟之前的交点重合。

因此这第 $k$ 条直线被分成了 $N_k + 1$ 段，每一段都落在一个不同的「平面区域块」之中。在放入第 $k$ 条直线之後，这 $N_k + 1$ 个「平面区域块」都遭一分为二，因此，放入直线 $k$ 导致增加 $N_k + 1$ 个分块。

因此我们可以从 $k = 0$ 的情况下递推；注意在没有任何直线的情况下，整个平面属于一整块，值应为 $1$。

所以可以写作 $1 + \sum_{k = 1}^n (N_k + 1)$，展开求和式得到 $1 + N + \sum_{k = 1}^{n}(N_k)$，也就是上面我们猜想得到的 $1 + n + k$。

#### Optimization

留意到根据题设，光线数据预先给定，并可能依据不同的 $x$ 坐标区间而被多次调用。每次都计算一遍交点比较浪费，也不快速。

我们可以提前用 $O(n^2)$ 的时间算好所有的交点位置并将其存储下来；假设一共有 $k$ 个交点，那么这样只需要消耗 $O(k)$ 的空间复杂度实现每次 $O(k)$ 时间复杂度的查询。

假如我们再进一步，在算好所有交点位置後花费 $O(k \times \log k)$ 的时间将所有交点按照 $x$ 坐标排序一遍，就可以利用「二分搜索」将每次查询的时间复杂度降低到 $O(\log k)$。

> 如果直接用 Heap 数据结构来存储交点，那么排序的时间复杂度会被平摊到每次插入中，总的时间复杂度会是 $O(n^2 \times \log k)$。

#### Code

考虑到我们可能需要处理斜率为 $\infin$ 的特殊直线，因此我们借助直线表示的一般式 $a x + b y + c = 0$ 来储存直线。

```python
class Light:
    a: float = 0.0
    b: float = 0.0
    c: float = 0.0

    def __init__(self, a: float, b: float, c: float):
        self.a = a
        self.b = b
        self.c = c
```

> 参见 `./src/light.py`。

测试用例方面，我们选择随机生成 $5$ 到 $20$ 个任意数值的 $a$、$b$、$c$，并且假定他们不出现三线及以上共点的情况。

> 参见 `./src/testcases.py`。

最後，求两根光直线的交点就变成了解一个二元一次方程组的问题。给 `Light` 类增加了一个 `intersect` 方法用于求交点。

> 参见 `./src/math_solution.py`。

注意：为了 Handle 无解（两直线无交点）和无穷解（两直线完全重合）的情况，定义了两个异常类。

> 参见 `./src/exceptions.py`。

